{% extends 'crm_app/base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  /* Dark mode enhancements */
  [data-bs-theme="dark"] .sidebar {
    background-color: #1a1a2e !important;
    border-right: 1px solid #2d2d42;
  }
  
  [data-bs-theme="dark"] .sidebar .nav-link {
    color: #e0e0e0;
  }
  
  [data-bs-theme="dark"] .sidebar .nav-link:hover {
    background-color: #2d2d42;
  }
  
  [data-bs-theme="dark"] .sidebar .nav-link.active {
    background-color: #3a3a5e;
    color: white;
  }
  
  [data-bs-theme="dark"] .sidebar hr {
    border-color: #2d2d42;
  }
  
  /* Clickable rows */
  .clickable-row {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .clickable-row:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
  }
  
  [data-bs-theme="dark"] .clickable-row:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  /* Prevent click on send reminder button */
  .no-row-click {
    pointer-events: auto !important;
  }
</style>

<div class="container-fluid">
 <!-- dd -->
  <div class="row">
    <!-- Sidebar Navigation -->
    <div class="col-md-3 col-lg-2 d-md-block sidebar collapse" style="background-color: #f8f9fa;">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#customers-section">
              <i class="fas fa-users me-2"></i> Customers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#leads-section">
              <i class="fas fa-chart-line me-2"></i> Leads
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#charts-section">
              <i class="fas fa-chart-pie me-2"></i> Analytics
            </a>
          </li>
          <li class="nav-item mt-3">
            <hr class="dropdown-divider">
          </li>
          <li class="nav-item">
            <a href="{% url 'add_customer' %}" class="nav-link text-primary">
              <i class="fas fa-plus-circle me-2"></i> Add Customer
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'add_lead' %}" class="nav-link text-primary">
              <i class="fas fa-plus me-2"></i> Add Lead
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 ms-sm-auto px-md-4 py-4">
      <!-- Customers Section -->
      <div id="customers-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="h4 text-primary">
            <i class="fas fa-users me-2"></i>Customers
            <span class="badge bg-primary rounded-pill">{{ customers.paginator.count }}</span>
          </h2>
          <div>
            <a href="{% url 'add_customer' %}" class="btn btn-sm btn-primary me-2">
              <i class="fas fa-plus me-1"></i> Add Customer
            </a>
            <a href="{% url 'upload_customers' %}" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-upload me-1"></i> Upload
            </a>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <form method="GET" class="mb-4">
              <div class="input-group">
                <input type="text" name="search" value="{{ query }}" class="form-control" 
                       placeholder="Search customers by name, email or company...">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search me-1"></i> Search
                </button>
              </div>
            </form>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Company</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <!-- dd -->

                <tbody>
                  {% for customer in customers %}
                  <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#customerModal{{ forloop.counter }}">
                    <td>{{ customer.name }}</td>
                    <td>{{ customer.email }}</td>
                    <td>{{ customer.phone }}</td>
                    <td>{{ customer.company }}</td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'edit_customer' customer.id %}" class="btn btn-outline-warning no-row-click" title="Edit" onclick="event.stopPropagation()">
                          <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'send_lead_reminders' customer.id %}" 
                           class="btn btn-info no-row-click send-reminder-btn" 
                           onclick="event.stopPropagation()">
                          <i class="fas fa-bell"></i> Send Status Reminder
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>

 </table>
            </div>

            {% if customers.has_other_pages %}
            <nav aria-label="Customer pagination">
              <ul class="pagination justify-content-center mt-3">
                {% if customers.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?customer_page={{ customers.previous_page_number }}{% if leads.number %}&lead_page={{ leads.number }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
                {% endif %}
                {% for num in customers.paginator.page_range %}
                <li class="page-item {% if customers.number == num %}active{% endif %}">
                  <a class="page-link" href="?customer_page={{ num }}{% if leads.number %}&lead_page={{ leads.number }}{% endif %}">{{ num }}</a>
                </li>
                {% endfor %}
                {% if customers.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?customer_page={{ customers.next_page_number }}{% if leads.number %}&lead_page={{ leads.number }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Leads Section -->
      <div id="leads-section" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="h4 text-success">
            <i class="fas fa-chart-line me-2"></i>Leads
            <span class="badge bg-success rounded-pill">{{ leads.paginator.count }}</span>
          </h2>
          <div>
            <a href="{% url 'add_lead' %}" class="btn btn-sm btn-success me-2">
              <i class="fas fa-plus me-1"></i> Add Lead
            </a>
            <a href="{% url 'upload_leads' %}" class="btn btn-sm btn-outline-success">
              <i class="fas fa-upload me-1"></i> Upload
            </a>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Title</th>
                    <th>Customer</th>
                    <th>Status</th>
                    <th>
                      <a href="?sort_by={% if sort_by == 'follow_up_date' %}-follow_up_date{% else %}follow_up_date{% endif %}{% if leads.number %}&lead_page={{ leads.number }}{% endif %}" class="text-decoration-none text-dark">
                        <i class="fas fa-calendar-alt me-1"></i>Follow-Up
                        {% if sort_by == 'follow_up_date' %}<i class="fas fa-arrow-down ms-1"></i>
                        {% elif sort_by == '-follow_up_date' %}<i class="fas fa-arrow-up ms-1"></i>
                        {% else %}<i class="fas fa-arrows-alt-v ms-1"></i>{% endif %}
                      </a>
                    </th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for lead in leads %}
                  <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#leadModal{{ forloop.counter }}">
                    <td>{{ lead.title }}</td>
                    <td>{{ lead.customer.name }}</td>
                    <td>
                      <span class="badge bg-{% if lead.status == 'New' %}info{% elif lead.status == 'Contacted' %}primary{% elif lead.status == 'Qualified' %}warning{% else %}success{% endif %}">
                        {{ lead.status }}
                      </span>
                    </td>
                    <td>{{ lead.follow_up_date|date:"M d, Y" }}</td>
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'send_reminder' lead.id %}" class="btn btn-outline-primary" title="Send Reminder" onclick="event.stopPropagation()">
                          <i class="fas fa-bell"></i>
                        </a>
                        <a href="{% url 'edit_lead' pk=lead.id %}" class="btn btn-outline-warning" title="Edit" onclick="event.stopPropagation()">
                          <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'delete_lead' lead.pk %}" class="btn btn-outline-danger" 
                           onclick="return confirm('Are you sure you want to delete this lead?')" title="Delete" onclick="event.stopPropagation()">
                          <i class="fas fa-trash"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            {% if leads.has_other_pages %}
            <nav aria-label="Lead pagination">
              <ul class="pagination justify-content-center mt-3">
                {% if leads.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?lead_page={{ leads.previous_page_number }}{% if customers.number %}&customer_page={{ customers.number }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
                {% endif %}
                {% for num in leads.paginator.page_range %}
                <li class="page-item {% if leads.number == num %}active{% endif %}">
                  <a class="page-link" href="?lead_page={{ num }}{% if customers.number %}&customer_page={{ customers.number }}{% endif %}">{{ num }}</a>
                </li>
                {% endfor %}
                {% if leads.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?lead_page={{ leads.next_page_number }}{% if customers.number %}&customer_page={{ customers.number }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Charts Section -->
{% if chart_data %}
<div id="charts-section" class="mb-5">
  <h2 class="h4 mb-4 text-info">
    <i class="fas fa-chart-bar me-2"></i>Analytics Dashboard
  </h2>
  
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card shadow-sm">
        <div class="card-header {% if request.user.is_authenticated and request.user.profile.dark_mode %}bg-dark text-white{% else %}bg-white{% endif %} border-bottom">
          <h3 class="h5 mb-0">
            <i class="fas fa-chart-bar me-2 text-primary"></i>
            <span class="text-dark-emphasis">Lead Status Distribution</span>
          </h3>
        </div>
        <div class="card-body">
          <div style="height: 300px;">
            <canvas id="leadChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Customer Modals -->
{% for customer in customers %}
<div class="modal fade" id="customerModal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Customer Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Name:</strong> {{ customer.name }}</p>
            <p><strong>Email:</strong> {{ customer.email }}</p>
            <p><strong>Phone:</strong> {{ customer.phone }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Company:</strong> {{ customer.company }}</p>
            <p><strong>Created:</strong> {{ customer.created_at|date:"M d, Y" }}</p>
            <p><strong>Last Updated:</strong> {{ customer.updated_at|date:"M d, Y" }}</p>
          </div>
        </div>
        <hr>
        <h6 class="mb-3">Associated Leads ({{ customer.lead_set.count }})</h6>
        {% if customer.lead_set.all %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Follow-Up</th>
                </tr>
              </thead>
              <tbody>
                {% for lead in customer.lead_set.all %}
                <tr>
                  <td>{{ lead.title }}</td>
                  <td><span class="badge bg-{% if lead.status == 'New' %}info{% elif lead.status == 'Contacted' %}primary{% elif lead.status == 'Qualified' %}warning{% else %}success{% endif %}">{{ lead.status }}</span></td>
                  <td>{{ lead.follow_up_date|date:"M d, Y" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No leads associated with this customer.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <a href="{% url 'edit_customer' customer.id %}" class="btn btn-warning">
          <i class="fas fa-edit me-1"></i> Edit
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Lead Modals -->
{% for lead in leads %}
<div class="modal fade" id="leadModal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong>Title:</strong> {{ lead.title }}</p>
            <p><strong>Customer:</strong> {{ lead.customer.name }}</p>
            <p><strong>Status:</strong> 
              <span class="badge bg-{% if lead.status == 'New' %}info{% elif lead.status == 'Contacted' %}primary{% elif lead.status == 'Qualified' %}warning{% else %}success{% endif %}">
                {{ lead.status }}
              </span>
            </p>
          </div>
          <div class="col-md-6">
            <p><strong>Follow-Up Date:</strong> {{ lead.follow_up_date|date:"M d, Y" }}</p>
            <p><strong>Created:</strong> {{ lead.created_at|date:"M d, Y" }}</p>
          </div>
        </div>
        <hr>
        <h6 class="mb-3">Description</h6>
        <p>{{ lead.description|default:"No description provided" }}</p>
      </div>
      <div class="modal-footer">
        <a href="{% url 'edit_lead' pk=lead.id %}" class="btn btn-warning">
          <i class="fas fa-edit me-1"></i> Edit
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

  <!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Initialize interactive chart
  const chartData = JSON.parse('{{ chart_data|escapejs }}');
  if (chartData) {
    const ctx = document.getElementById('leadChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Lead Count by Status',
          data: chartData.data,
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(153, 102, 255, 0.6)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(153, 102, 255, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }
</script>

<script>
  // Initialize chart if data exists
  const chartData = JSON.parse('{{ chart_data|escapejs }}');
  if (chartData) {
    const ctx = document.getElementById('leadChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Lead Count by Status',
          data: chartData.data,
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(153, 102, 255, 0.6)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(153, 102, 255, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Handle row clicks and prevent propagation for specific buttons
  document.addEventListener('DOMContentLoaded', function() {
    // Make rows clickable
    document.querySelectorAll('.clickable-row').forEach(row => {
      row.addEventListener('click', function(e) {
        // Check if click originated from a no-row-click element
        if (e.target.closest('.no-row-click')) {
          return;
        }
        const modalId = this.getAttribute('data-bs-target');
        if (modalId) {
          const modal = new bootstrap.Modal(document.querySelector(modalId));
          modal.show();
        }
      });
    });

    // Smooth scroll for sidebar navigation
    document.querySelectorAll('.nav-link').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        if (this.getAttribute('href').startsWith('#')) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          const targetElement = document.querySelector(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth'
            });
            
            // Update active state in sidebar
            document.querySelectorAll('.nav-link').forEach(link => {
              link.classList.remove('active');
            });
            this.classList.add('active');
          }
        }
      });
    });
  });
</script>
{% endblock %}